# macOS App Building and Packaging Guide for Image Restoration Suite

This guide covers building, packaging, and distributing the Image Restoration Suite as a proper macOS desktop application with version targeting, architecture support, and self-signing.

## Prerequisites

1. **Install Fyne Command Line Tools**:
```bash
go install fyne.io/fyne/v2/cmd/fyne@latest
```

2. **Prepare an App Icon**:
   - Create an app icon as `icon.png` (512x512px recommended)
   - Place it in your project root directory
   - The `FyneApp.toml` already references `icon.png`

3. **Verify Dependencies**:
   - Go 1.24+
   - OpenCV 4.11.0+
   - Xcode Command Line Tools: `xcode-select --install`

## Minimum macOS Version Configuration

### Understanding Version Control

The minimum macOS version for your app is determined by several factors in order of priority:

1. **MACOSX_DEPLOYMENT_TARGET Environment Variable** (Primary control)
2. **SDK Version Used** during compilation
3. **Go Build Flags** and Fyne requirements
4. **OpenCV Requirements** (4.11.0 in your case)
5. **Fyne Framework Requirements** (v2.6.1)

**Important:** `FyneApp.toml` does **NOT** control the minimum macOS version. The `LSMinimumSystemVersion` in `Info.plist` is what macOS reads, and this is automatically generated by Fyne during packaging based on your build settings.

### Recommended Minimum Version: **macOS 10.15 (Catalina)**

**Reasoning:**
- OpenCV 4.11.0 works well on macOS 10.15+
- Fyne v2.6.1 supports macOS 10.14+ but 10.15+ is more stable
- Go 1.24 has good support for macOS 10.15+
- Apple Silicon support (M1/M2/M3) requires macOS 11.0+, but Intel Macs can run 10.15
- Wide compatibility while supporting modern features

## Architecture-Specific Building

### Current Architecture Detection

```bash
# Check what architecture you're running on
uname -m
# Returns: arm64 (Apple Silicon) or x86_64 (Intel)

# Check Go's view of the architecture  
go env GOARCH
# Returns: arm64 or amd64
```

### For Apple Silicon (ARM64) Macs

```bash
# Build for ARM64 (Apple Silicon) only with version control
export MACOSX_DEPLOYMENT_TARGET=11.0  # ARM64 requires macOS 11.0+
GOOS=darwin GOARCH=arm64 CGO_ENABLED=1 go build -ldflags="-s -w" -o image-restoration-suite-arm64 .
fyne package -os darwin -executable image-restoration-suite-arm64
```

### For Intel x86_64 Macs

```bash
# Build for x86_64 (Intel) only with version control
export MACOSX_DEPLOYMENT_TARGET=10.15  # Intel can support older versions
GOOS=darwin GOARCH=amd64 CGO_ENABLED=1 go build -ldflags="-s -w" -o image-restoration-suite-x86_64 .
fyne package -os darwin -executable image-restoration-suite-x86_64
```

### Universal Binary (Recommended for Distribution)

```bash
# Set deployment target for wide compatibility
export MACOSX_DEPLOYMENT_TARGET=10.15

# Build both architectures
GOOS=darwin GOARCH=arm64 CGO_ENABLED=1 go build -ldflags="-s -w" -o image-restoration-suite-arm64 .
GOOS=darwin GOARCH=amd64 CGO_ENABLED=1 go build -ldflags="-s -w" -o image-restoration-suite-x86_64 .

# Create universal binary using lipo
lipo -create -output image-restoration-suite image-restoration-suite-arm64 image-restoration-suite-x86_64

# Package app
fyne package -os darwin -executable image-restoration-suite

# Sign with official Apple certificate
codesign --force --options runtime --deep --sign "${CERT}" -i "${APP_ID}" "${APP_NAME}.app"

# Create a DMG for distribution
hdiutil create -srcfolder "${APP_NAME}.app" "${APP_NAME}.dmg"

# Sign the DMG
codesign --sign "${CERT}" -i "${APP_ID}" "${APP_NAME}.dmg"

echo "Created signed app and DMG for distribution"
```

## Verification and Testing

### Version and Architecture Verification

```bash
# Check deployment target in the binary
otool -l "Image Restoration Suite.app/Contents/MacOS/Image Restoration Suite" | grep -A3 LC_VERSION_MIN_MACOSX

# For newer format, check build version
otool -l "Image Restoration Suite.app/Contents/MacOS/Image Restoration Suite" | grep -A3 LC_BUILD_VERSION

# Check Info.plist for LSMinimumSystemVersion (auto-generated by Fyne)
plutil -p "Image Restoration Suite.app/Contents/Info.plist" | grep -i minimum

# Check what architectures are included
lipo -info "Image Restoration Suite.app/Contents/MacOS/Image Restoration Suite"

# Check OpenCV linking
otool -L "Image Restoration Suite.app/Contents/MacOS/Image Restoration Suite" | grep opencv
```

### App Verification

```bash
# Check Applications folder
ls -la /Applications/ | grep "Image Restoration"

# Launch from command line
open "/Applications/Image Restoration Suite.app"

# Check app info
mdls "/Applications/Image Restoration Suite.app"

# Basic verification
codesign --verify "Image Restoration Suite.app"

# Detailed verification  
codesign --verify --verbose=4 "Image Restoration Suite.app"
```

## Troubleshooting

### Version-Related Issues

**App shows "requires macOS X.X or later"**:
- Rebuild with `MACOSX_DEPLOYMENT_TARGET` set to older version
- Verify deployment target with `otool -l`

**OpenCV not found**:
- Ensure OpenCV is properly installed: `brew install opencv`
- Check linking: `otool -L` on the binary

**Architecture mismatch**:
- Build universal binary for compatibility
- Check architectures: `lipo -info`

### Signing Issues

**"No identity found"**:
- Create self-signed certificate in Keychain Access
- Use certificate exact name in codesign command

**Gatekeeper warnings**:
- Remove quarantine: `xattr -dr com.apple.quarantine app.app`
- Or allow in System Preferences > Security & Privacy

## Distribution Strategy Summary

### For Wide Compatibility (Recommended)
- **Minimum Version**: macOS 10.15 (Catalina)
- **Architecture**: Universal Binary (Intel + Apple Silicon)
- **Build Command**: `./build-universal-macos.sh`
- **Distribution**: Self-signed for local use, officially signed for public

### For Modern Macs Only
- **Minimum Version**: macOS 12.0 (Monterey) 
- **Architecture**: Universal Binary or Apple Silicon only
- **Benefits**: Access to newer macOS APIs and better performance

### Quick Start Summary

```bash
# 1. Set up self-signed certificate (one-time setup)
# Use Keychain Access method above

# 2. Build universal app with proper version targeting
export MACOSX_DEPLOYMENT_TARGET=10.15
./build-universal-macos.sh

# 3. Install to Applications
cp -R "Image Restoration Suite.app" /Applications/

# 4. Launch from Applications folder or Launchpad
```

Your Image Restoration Suite will now appear as a proper macOS application with:
- ‚úÖ Proper app icon in Applications folder and Launchpad
- ‚úÖ Support for both Intel and Apple Silicon Macs
- ‚úÖ Minimum macOS 10.15 compatibility
- ‚úÖ Self-signed for local installation
- ‚úÖ All OpenCV and Fyne dependencies properly bundled image-restoration-suite-x86_64

# Package the universal binary
fyne package -os darwin -executable image-restoration-suite

# Clean up individual architecture binaries
rm image-restoration-suite-arm64 image-restoration-suite-x86_64 image-restoration-suite
```

### Using fyne-cross for Cross-Compilation

```bash
# Install fyne-cross
go install github.com/fyne-io/fyne-cross@latest

# Build for specific architecture
fyne-cross darwin -arch amd64        # Intel only
fyne-cross darwin -arch arm64        # Apple Silicon only  
fyne-cross darwin -arch "*"          # Universal binary (both)
```

## Simple Packaging Methods

### Method 1: Default Packaging with Version Control

```bash
# Navigate to your project directory
cd image-restoration-suite

# Set minimum macOS version
export MACOSX_DEPLOYMENT_TARGET=10.15

# Package the app for macOS (uses current architecture)
fyne package -os darwin
```

This will create `Image Restoration Suite.app` using the name from `FyneApp.toml`.

### Method 2: Custom Icon and Name with Version Control

```bash
# Set minimum version and package with custom settings
export MACOSX_DEPLOYMENT_TARGET=10.15
fyne package -os darwin -icon icon.png -name "Image Restoration Suite"
```

### Method 3: Using FyneApp.toml (Current Setup)

Your project already has a properly configured `FyneApp.toml` file:
```toml
Website = "https://github.com/ervinsstrauhmanis/image-restoration-suite"

[Details]
  Icon = "icon.png"
  Name = "Image Restoration Suite"
  ID = "com.imagerestoration.suite"
  Version = "1.0.0"
  Build = 1

[LinuxAndBSD]
  GenericName = "Image Processing Tool"
  Categories = ["Graphics", "Photography"]
  Comment = "Image restoration and processing suite for historical documents and illustrations."
  Keywords = ["image", "restoration", "processing", "opencv", "otsu"]
```

**No changes needed to FyneApp.toml** - version targeting happens at build time.

With this file present, simply run:
```bash
export MACOSX_DEPLOYMENT_TARGET=10.15
fyne package -os darwin
```

## Self-Signing Your macOS App

Self-signing allows your app to run without security warnings and makes development/testing easier.

### Method 1: Create Self-Signed Certificate via Keychain Access

1. **Open Keychain Access**:
   - Launch `Keychain Access.app` from Applications/Utilities

2. **Create Certificate**:
   - Go to `Keychain Access` ‚Üí `Certificate Assistant` ‚Üí `Create a Certificate...`
   - **Name**: Enter a descriptive name (e.g., "Image Restoration Suite Developer")
   - **Identity Type**: Select "Self Signed Root"
   - **Certificate Type**: Select "Code Signing"
   - **Let me override defaults**: Check this box
   - Click **Continue**

3. **Configure Certificate**:
   - **Serial Number**: Leave default
   - **Validity Period**: Set to desired duration (365 days recommended)
   - Click **Continue** through the remaining screens, accepting defaults
   - Choose **Keychain**: Select "login" keychain
   - Click **Create**

4. **Sign Your App**:
```bash
# Build and package your app first with version control
export MACOSX_DEPLOYMENT_TARGET=10.15
fyne package -os darwin

# Sign the app bundle with your self-signed certificate
codesign --force --deep --sign "Image Restoration Suite Developer" "Image Restoration Suite.app"

# Verify the signature
codesign --verify --verbose "Image Restoration Suite.app"
```

### Method 2: Command Line Self-Signed Certificate

```bash
# Create certificate configuration file
cat > self-sign.conf << EOF
[ req ]
default_bits = 4096
distinguished_name = req_distinguished_name
req_extensions = v3_req
prompt = no

[ req_distinguished_name ]
CN = Image Restoration Suite Developer

[ v3_req ]
keyUsage = keyEncipherment, dataEncipherment, digitalSignature
extendedKeyUsage = codeSigning
EOF

# Generate private key and certificate
openssl req -config self-sign.conf -x509 -newkey rsa:4096 -keyout selfSignedKey.pem -out selfSigned.pem -days 365 -nodes

# Create PKCS12 bundle
openssl pkcs12 -export -out developer-cert.p12 -inkey selfSignedKey.pem -in selfSigned.pem -passout pass:

# Import to keychain
security import developer-cert.p12 -k ~/Library/Keychains/login.keychain-db

# Sign your app
export MACOSX_DEPLOYMENT_TARGET=10.15
fyne package -os darwin
codesign --force --deep --sign "Image Restoration Suite Developer" "Image Restoration Suite.app"
```

### Method 3: Quick Ad-hoc Signing

```bash
# Build and package with version control
export MACOSX_DEPLOYMENT_TARGET=10.15
fyne package -os darwin

# Ad-hoc sign (no certificate needed)
codesign --force --deep --sign - "Image Restoration Suite.app"
```

### Verifying Your Signature

```bash
# Basic verification
codesign --verify "Image Restoration Suite.app"

# Detailed verification  
codesign --verify --verbose=4 "Image Restoration Suite.app"

# Check what certificate was used
codesign --display --verbose=4 "Image Restoration Suite.app"
```

### Removing Quarantine (if needed)

```bash
# Remove quarantine attribute
xattr -d com.apple.quarantine "Image Restoration Suite.app"

# Or for the entire bundle
xattr -dr com.apple.quarantine "Image Restoration Suite.app"
```

## Complete Build Scripts

### Universal Binary Build Script with Version Control

Create `build-universal-macos.sh`:

```bash
#!/bin/bash

# Universal Binary Build Script for Image Restoration Suite
APP_NAME="Image Restoration Suite"
APP_ID="com.imagerestoration.suite"
MIN_MACOS_VERSION="10.15"
CERT_NAME="Image Restoration Suite Developer"  # Your self-signed cert name

echo "Building Universal Binary for Image Restoration Suite..."
echo "Target minimum macOS version: ${MIN_MACOS_VERSION}"

# Set deployment target for wide compatibility
export MACOSX_DEPLOYMENT_TARGET=${MIN_MACOS_VERSION}

# Clean previous builds
rm -rf "*.app" image-restoration-suite*

echo "Building ARM64 binary..."
GOOS=darwin GOARCH=arm64 CGO_ENABLED=1 go build -ldflags="-s -w" -o image-restoration-suite-arm64 .

echo "Building x86_64 binary..."  
GOOS=darwin GOARCH=amd64 CGO_ENABLED=1 go build -ldflags="-s -w" -o image-restoration-suite-x86_64 .

echo "Creating universal binary..."
lipo -create -output image-restoration-suite image-restoration-suite-arm64 image-restoration-suite-x86_64

echo "Packaging macOS app..."
fyne package -os darwin -executable image-restoration-suite

echo "Self-signing app..."
codesign --force --deep --sign "${CERT_NAME}" "${APP_NAME}.app" 2>/dev/null || \
codesign --force --deep --sign - "${APP_NAME}.app"

echo "Verifying signature..."
codesign --verify --verbose "${APP_NAME}.app"

# Clean up individual binaries
rm -f image-restoration-suite-arm64 image-restoration-suite-x86_64 image-restoration-suite

if [ -d "${APP_NAME}.app" ]; then
    echo "‚úÖ Successfully created universal ${APP_NAME}.app"
    echo "üìÅ App bundle location: $(pwd)/${APP_NAME}.app"
    echo "üì± Minimum macOS version: ${MIN_MACOS_VERSION}"
    
    # Check what architectures are included
    echo "üèóÔ∏è  Architectures included:"
    lipo -info "${APP_NAME}.app/Contents/MacOS/Image Restoration Suite"
    
    # Verify deployment target
    echo "üîç Verifying deployment target..."
    otool -l "${APP_NAME}.app/Contents/MacOS/Image Restoration Suite" | grep -A3 LC_BUILD_VERSION || \
    otool -l "${APP_NAME}.app/Contents/MacOS/Image Restoration Suite" | grep -A3 LC_VERSION_MIN_MACOSX
    
    echo ""
    echo "To install:"
    echo "  cp -R '${APP_NAME}.app' /Applications/"
    echo ""
    echo "Or drag and drop the .app bundle to Applications folder"
else
    echo "‚ùå Failed to create app bundle"
    exit 1
fi
```

### ARM64-Only Build Script

Create `build-arm64-macos.sh`:

```bash
#!/bin/bash

# ARM64 Build Script for Apple Silicon Macs
APP_NAME="Image Restoration Suite"
MIN_MACOS_VERSION="11.0"  # ARM64 requires macOS 11.0+
CERT_NAME="Image Restoration Suite Developer"

echo "Building ARM64 binary for Apple Silicon..."
echo "Target minimum macOS version: ${MIN_MACOS_VERSION}"

# Set deployment target
export MACOSX_DEPLOYMENT_TARGET=${MIN_MACOS_VERSION}

# Clean previous builds
rm -rf "*.app" image-restoration-suite*

echo "Building ARM64 binary..."
GOOS=darwin GOARCH=arm64 CGO_ENABLED=1 go build -ldflags="-s -w" -o image-restoration-suite .

echo "Packaging macOS app..."
fyne package -os darwin -executable image-restoration-suite

echo "Self-signing app..."
codesign --force --deep --sign "${CERT_NAME}" "${APP_NAME}.app" 2>/dev/null || \
codesign --force --deep --sign - "${APP_NAME}.app"

# Clean up binary
rm -f image-restoration-suite

echo "‚úÖ ARM64 build complete: ${APP_NAME}.app"
echo "üì± Minimum macOS version: ${MIN_MACOS_VERSION} (Apple Silicon only)"
```

### Intel x86_64-Only Build Script

Create `build-intel-macos.sh`:

```bash
#!/bin/bash

# Intel x86_64 Build Script  
APP_NAME="Image Restoration Suite"
MIN_MACOS_VERSION="10.15"  # Intel can support older versions
CERT_NAME="Image Restoration Suite Developer"

echo "Building x86_64 binary for Intel Macs..."
echo "Target minimum macOS version: ${MIN_MACOS_VERSION}"

# Set deployment target
export MACOSX_DEPLOYMENT_TARGET=${MIN_MACOS_VERSION}

# Clean previous builds
rm -rf "*.app" image-restoration-suite*

echo "Building x86_64 binary..."
GOOS=darwin GOARCH=amd64 CGO_ENABLED=1 go build -ldflags="-s -w" -o image-restoration-suite .

echo "Packaging macOS app..."
fyne package -os darwin -executable image-restoration-suite

echo "Self-signing app..."
codesign --force --deep --sign "${CERT_NAME}" "${APP_NAME}.app" 2>/dev/null || \
codesign --force --deep --sign - "${APP_NAME}.app"

# Clean up binary
rm -f image-restoration-suite

echo "‚úÖ Intel x86_64 build complete: ${APP_NAME}.app"
echo "üì± Minimum macOS version: ${MIN_MACOS_VERSION} (Intel only)"
```

### Auto-Detection Build Script

Create `build-auto-detect.sh`:

```bash
#!/bin/bash

APP_NAME="Image Restoration Suite"
CURRENT_ARCH=$(uname -m)
CERT_NAME="Image Restoration Suite Developer"

echo "Current architecture: ${CURRENT_ARCH}"
echo "Building Image Restoration Suite..."

# Clean previous builds
rm -rf "*.app" image-restoration-suite*

if [ "$CURRENT_ARCH" = "arm64" ]; then
    echo "Building on Apple Silicon - creating universal binary for maximum compatibility..."
    
    # Set deployment target for wide compatibility
    export MACOSX_DEPLOYMENT_TARGET=10.15
    
    # Build both architectures on Apple Silicon
    echo "Building ARM64 binary..."
    GOOS=darwin GOARCH=arm64 CGO_ENABLED=1 go build -ldflags="-s -w" -o image-restoration-suite-arm64 .
    
    echo "Building x86_64 binary..."
    GOOS=darwin GOARCH=amd64 CGO_ENABLED=1 go build -ldflags="-s -w" -o image-restoration-suite-x86_64 .
    
    echo "Creating universal binary..."
    lipo -create -output image-restoration-suite image-restoration-suite-arm64 image-restoration-suite-x86_64
    
    # Clean up individual binaries
    rm -f image-restoration-suite-arm64 image-restoration-suite-x86_64
    
    fyne package -os darwin -executable image-restoration-suite
    rm -f image-restoration-suite
    
    echo "‚úÖ Universal binary created (ARM64 + Intel, min macOS 10.15)"
    
elif [ "$CURRENT_ARCH" = "x86_64" ]; then
    echo "Building on Intel - creating Intel-only binary..."
    
    # Set deployment target for Intel compatibility
    export MACOSX_DEPLOYMENT_TARGET=10.15
    
    # Build for Intel only
    GOOS=darwin GOARCH=amd64 CGO_ENABLED=1 go build -ldflags="-s -w" -o image-restoration-suite .
    fyne package -os darwin -executable image-restoration-suite
    rm -f image-restoration-suite
    
    echo "‚úÖ Intel x86_64 binary created (min macOS 10.15)"
    echo "‚ÑπÔ∏è  Note: This build will run on Apple Silicon via Rosetta 2"
    
else
    echo "‚ùå Unknown architecture: ${CURRENT_ARCH}"
    exit 1
fi

# Self-sign the app
echo "Self-signing app..."
codesign --force --deep --sign "${CERT_NAME}" "${APP_NAME}.app" 2>/dev/null || \
codesign --force --deep --sign - "${APP_NAME}.app"

# Verify
codesign --verify --verbose "${APP_NAME}.app"

if [ -d "${APP_NAME}.app" ]; then
    # Show architecture info
    echo "üèóÔ∏è  Final binary architectures:"
    lipo -info "${APP_NAME}.app/Contents/MacOS/Image Restoration Suite" 2>/dev/null || echo "   Single architecture binary"
    
    # Show deployment target
    echo "üîç Deployment target verification:"
    otool -l "${APP_NAME}.app/Contents/MacOS/Image Restoration Suite" | grep -A3 LC_BUILD_VERSION || \
    otool -l "${APP_NAME}.app/Contents/MacOS/Image Restoration Suite" | grep -A3 LC_VERSION_MIN_MACOSX
    
    echo ""
    echo "üìÅ App bundle created: $(pwd)/${APP_NAME}.app"
    echo "To install: cp -R '${APP_NAME}.app' /Applications/"
fi
```

Make the scripts executable:
```bash
chmod +x build-universal-macos.sh build-arm64-macos.sh build-intel-macos.sh build-auto-detect.sh
```

## Installation and Distribution

### Automatic Installation Script

Create `install-macos.sh`:

```bash
#!/bin/bash

APP_NAME="Image Restoration Suite"

# Check if app exists
if [ ! -d "${APP_NAME}.app" ]; then
    echo "App bundle not found. Run packaging first:"
    echo "  ./build-universal-macos.sh"
    exit 1
fi

# Install to Applications
echo "Installing ${APP_NAME} to Applications..."
cp -R "${APP_NAME}.app" /Applications/

if [ $? -eq 0 ]; then
    echo "‚úÖ Successfully installed to /Applications/"
    echo "üöÄ You can now launch ${APP_NAME} from Launchpad or Applications folder"
    
    # Check what architectures are supported
    if command -v lipo &> /dev/null; then
        echo "üèóÔ∏è  Supported architectures:"
        lipo -info "/Applications/${APP_NAME}.app/Contents/MacOS/Image Restoration Suite" 2>/dev/null || echo "   Unable to determine architectures"
    fi
    
    # Show minimum version
    echo "üì± Minimum macOS version:"
    plutil -p "/Applications/${APP_NAME}.app/Contents/Info.plist" | grep -i minimum || echo "   Check with otool -l"
else
    echo "‚ùå Installation failed. You may need to run with sudo:"
    echo "  sudo cp -R '${APP_NAME}.app' /Applications/"
fi
```

### Using Fyne Install Command

```bash
# Set minimum version and build/install in one step
export MACOSX_DEPLOYMENT_TARGET=10.15
fyne install -os darwin
```
